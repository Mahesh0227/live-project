<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Student - MR Technologies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #113C71;
      --secondary-color: #f8f9fc;
      --accent-color: #03306e;
      --success-color: #16a34a;
      --danger-color: #dc2626;
      --text-color: #333333;
      --muted-text: #6b7280;
      --white: #ffffff;
      --font-base: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --transition-speed: 0.3s;
      --card-radius: 12px;
      --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: var(--font-base);
    }

    body {
      background-color: #f0f0f0;
    }

    .slide-link {
      position: relative;
      overflow: hidden;
      transition: background 0.3s ease;
    }
    .slide-link::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transition: left var(--transition-speed) ease;
    }
    .slide-link:hover::before {
      left: 0;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .row-animate {
      animation: fadeSlideIn 0.4s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex font-sans">

  <!-- Sidebar -->
 
  <header class="flex justify-between items-center bg-white shadow-md p-3 fixed top-0 left-0 right-0 z-50">
  <div class="flex items-center gap-4">
    <img src="/images/logo.jpg" alt="MR Technologies Logo" class="h-16 object-contain">
    <img src="/images/studentedit.png" alt="" style="width: 4rem;height: 4rem;">
    <h1 class="text-2xl font-bold text-[var(--primary-color)]">Student Edit Form</h1>
  </div>
  <p class="text-sm text-gray-600">
    Welcome, <span class="font-semibold text-[var(--primary-color)]" id="username">Loading...</span>
  </p>
</header>

<!-- Page Layout -->
<div class="flex flex-1 pt-20">
  <!-- Sidebar -->
  <aside class="fixed top-[80px] left-0 w-72 bg-[var(--primary-color)] text-white" style="height: calc(100% - 80px); padding-top: 10px; z-index: 30; font-size: 20px;">
    <nav class="flex flex-col gap-4" style="margin-top: 10%; margin-left: 10%;">
      <a href="/dashboard" class="p-3 rounded slide-link">Dashboard</a>
      <a href="/courses" class="p-3 rounded slide-link">Courses</a>
      <a href="/studenthome" class="p-3 rounded slide-link">Students</a>
      <a href="/Batch" class="p-3 rounded slide-link">Batch</a>
      <a href="/payments" class="p-3 rounded slide-link">Finance</a>
      <a href="/reports" class="p-3 rounded slide-link">Reports</a>
    </nav>
    <button onclick="logout()" class="mt-4 text-left text-red-300 hover:text-white p-3 transition" style="margin-left: 10%;">Logout</button>
  </aside>

  <div class="flex-1 ml-72 p-8 pt-24 bg-gray-100 min-h-screen">
  <form onsubmit="return validateForm()" id="editForm" class="space-y-6 max-w-5xl mx-auto">

    <!-- Tabs Navigation -->
    <div class="flex border-b border-gray-300 mb-6">
      <button type="button" class="tab-btn px-4 py-2 font-semibold border-b-2 "
        data-step="1" style="border: var(--accent-color); color: var(--primary-color);">Personal Info</button>
      <button type="button" class="tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-indigo-600"
        data-step="2"style="border: var(--accent-color); color: var(--primary-color);">Course Details</button>
      <button type="button" class="tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-indigo-600"
        data-step="3"style="border: var(--accent-color); color: var(--primary-color);">Payment Details</button>
      <button type="button" class="tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-indigo-600"
        data-step="4"style="border: var(--accent-color); color: var(--primary-color);">Preview</button>
    </div>
    <!-- Step 1: Personal Info -->
    <div class="form-step" data-step="1">
      <div class="bg-white shadow-md rounded-xl p-6 space-y-6 border border-gray-200">
        <h2 class="text-lg font-semibold text-indigo-700 border-b pb-2"style="color: var(--primary-color);font: 2em sans-serif;">Personal Information</h2>

        <!-- Full Name -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="name" class="font-medium md:text-right">Full Name</label>
          <div class="md:col-span-2">
            <input type="text" name="name" id="name"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Email -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="email" class="font-medium md:text-right">Email</label>
          <div class="md:col-span-2">
            <input type="email" name="email" id="email"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Mobile -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="mobile" class="font-medium md:text-right">Mobile Number</label>
          <div class="md:col-span-2">
            <input type="tel" name="mobile" id="mobile"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Date of Birth -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="dob" class="font-medium md:text-right">Date of Birth</label>
          <div class="md:col-span-2">
            <input type="date" name="dob" id="dob"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Gender -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label class="font-medium md:text-right">Gender</label>
          <div class="flex gap-4 md:col-span-2">
            <label><input type="radio" name="gender" value="Male" required> Male</label>
            <label><input type="radio" name="gender" value="Female"> Female</label>
            <label><input type="radio" name="gender" value="Other"> Other</label>
          </div>
        </div>

        <!-- Address -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="address" class="font-medium md:text-right">Address</label>
          <div class="md:col-span-2">
            <textarea name="address" id="address" rows="3"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required></textarea>
          </div>
        </div>
      </div>

      <!-- Next -->
      <div class="flex justify-end mt-4">
        <button type="button" class="next-btn bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          data-next="2">Next</button>
      </div>
    </div>

    <!-- Step 2: Course Details -->
    <div class="form-step hidden" data-step="2">
      <div class="bg-white shadow-md rounded-xl p-6 space-y-6 border border-gray-200">
        <h2 class="text-lg font-semibold text-indigo-700 border-b pb-2"style="color: var(--primary-color);font: 2em sans-serif;">Course Details</h2>

        <!-- Highest Qualification -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="qualification" class="font-medium md:text-right">Highest Qualification</label>
          <div class="md:col-span-2">
            <select name="qualification" id="qualification"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
              <option value="">Select</option>
              <option>10th</option>
              <option>12th</option>
              <option>Diploma</option>
              <option>Degree</option>
              <option>B-Tech</option>
              <option>PG</option>
            </select>
          </div>
        </div>

        <!-- Joining Date -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="joiningDate" class="font-medium md:text-right">Joining Date</label>
          <div class="md:col-span-2">
            <input type="date" name="joiningDate" id="joiningDate"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>
		<!-- Course -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="courseDropdown" class="font-medium md:text-right">Course</label>
          <div class="md:col-span-2">
            <select name="course" id="courseDropdown"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
        <!-- Batch -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="batchDropdown" class="font-medium md:text-right">Batch</label>
          <div class="md:col-span-2">
            <select name="batch" id="batchDropdown"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
              <option value="">Select</option>
            </select>
          </div>
        </div>

        <!-- Batch Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="batchStatus" class="font-medium md:text-right">Batch Status</label>
          <div class="md:col-span-2">
            <input type="text" name="status" id="batchStatus"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        

        <!-- Duration -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="duration" class="font-medium md:text-right">Duration</label>
          <div class="md:col-span-2">
            <input type="text" name="duration" id="duration"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="flex justify-between mt-4">
        <button type="button" class="prev-btn bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500"
          data-prev="1">Back</button>
        <button type="button" class="next-btn bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          data-next="3">Next</button>
      </div>
    </div>

    <!-- Step 3: Payment Details -->
    <div class="form-step hidden" data-step="3">
      <div class="bg-white shadow-md rounded-xl p-6 space-y-6 border border-gray-200">
        <h2 class="text-lg font-semibold text-indigo-700 border-b pb-2"style="color: var(--primary-color);font: 2em sans-serif;">Payment Details</h2>

        <!-- Course Amount -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label for="Coursefee" class="font-medium md:text-right">Course Amount</label>
          <div class="md:col-span-2">
            <input type="number" name="coursefee" id="coursefee"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Discount -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label class="font-medium md:text-right">Discount</label>
          <div class="md:col-span-2">
            <input type="number" name="discount" id="discount"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Total Amount -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label class="font-medium md:text-right">Total Amount</label>
          <div class="md:col-span-2">
            <input type="number" name="totalfee"id="totalfee"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Term-I fees -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label class="font-medium md:text-right">Term-I Fees</label>
          <div class="md:col-span-2">
            <input type="number" name="term_1"id="term_1"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Paid Amount -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label class="font-medium md:text-right">Paid Amount</label>
          <div class="md:col-span-2">
            <input type="number" name="paidamount"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>

        <!-- Due Amount -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
          <label class="font-medium md:text-right">Due Amount</label>
          <div class="md:col-span-2">
            <input type="number" name="duefee" id="duefee"
              class="w-full border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-400" required>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="flex justify-between mt-4">
        <button type="button" class="prev-btn bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500"
          data-prev="2">Back</button>
        <button type="button" class="next-btn bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          data-next="4">Next</button>
      </div>
    </div>

    <!-- Step 4: Preview -->
<div class="form-step hidden" data-step="4">
          <div class="bg-white shadow-md rounded-xl p-6 border border-gray-200">
            <h2 class="text-lg font-semibold border-b pb-2" style="color: var(--primary-color); font: 2em sans-serif;">Preview Details</h2>
            <div id="previewContent" class="space-y-2"></div>
          </div>
          <div class="flex justify-between mt-4">
            <button type="button" class="prev-btn bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500" data-prev="3">Back</button>
            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Submit</button>
          </div>
        </div>

  </form>
  </div>

  <script th:inline="javascript">
    const id = /*[[${studentId}]]*/ 0;
</script>

<script>
    const steps = document.querySelectorAll(".form-step");
    const tabBtns = document.querySelectorAll(".tab-btn");
    let courseMap = new Map();
    let batchMap = new Map();
    let student = null;

    // Fetch student data
    fetch("http://localhost:8080/api/students/" + id)
      .then(res => res.json())
      .then(data => {
        student = data;

        // Fill all simple fields
        for (const key in student) {
          const el = document.getElementById(key);
          if (el) {
            if (el.type === "date" && student[key]) {
              el.value = new Date(student[key]).toISOString().split("T")[0];
            } else {
              el.value = student[key];
            }
          }
        }

        // Set gender
        if (student.gender) {
          const radio = document.querySelector(`input[name="gender"][value="${student.gender}"]`);
          if (radio) radio.checked = true;
        }

        // Qualification
        if (student.qualification) {
          document.getElementById("qualification").value = student.qualification;
        }

        // ✅ Paid amount from student table
        if (student.paidamount !== undefined) {
          document.querySelector("input[name='paidamount']").value = student.paidamount;
        }

        // ✅ Batch status from student table
        if (student.status !== undefined) {
          document.getElementById("batchStatus").value = student.status;
        }

        // Load course dropdown and preselect
        loadCourses(student.course, student.batch);
      });

    // Load courses
    function loadCourses(selectedCourse, selectedBatch) {
      fetch("http://localhost:8080/api/courses/all")
        .then(res => res.json())
        .then(courses => {
          const dropdown = document.getElementById("courseDropdown");
          dropdown.innerHTML = '<option value="">Select</option>';
          courses.forEach(course => {
            courseMap.set(course.coursename, { duration: course.duration, coursefee: course.coursefee });
            const option = document.createElement("option");
            option.value = course.coursename;
            option.textContent = course.coursename;
            if (selectedCourse === course.coursename) option.selected = true;
            dropdown.appendChild(option);
          });

          // Fill duration & fee for selected course
          const courseData = courseMap.get(selectedCourse);
          if (courseData) {
            document.querySelector("input[name='duration']").value = courseData.duration + " days";
            document.querySelector("input[name='coursefee']").value = courseData.coursefee;
          }

          // Load batches for selected course
          if (selectedCourse) {
            loadBatchesForCourse(selectedCourse, selectedBatch);
          }
        });
    }

    // Load batches for course
    function loadBatchesForCourse(courseName, selectedBatch) {
      fetch(`http://localhost:8080/api/batch/byCourse/${encodeURIComponent(courseName)}`)
        .then(res => res.json())
        .then(batches => {
          const dropdown = document.getElementById("batchDropdown");
          dropdown.innerHTML = '<option value="">Select</option>';
          batchMap.clear();

          batches.forEach(batch => {
            batchMap.set(batch.batchid, batch.status);
            const option = document.createElement("option");
            option.value = batch.batchid;
            option.textContent = `${batch.batchid} (${batch.status})`;
            if (selectedBatch === batch.batchid) {
              option.selected = true;
            }
            dropdown.appendChild(option);
          });
        })
        .catch(err => console.error("Error loading batches:", err));
    }

    // When course changes
    document.getElementById("courseDropdown").addEventListener("change", function () {
      const selectedCourse = this.value;
      const courseData = courseMap.get(selectedCourse);

      if (courseData) {
        document.querySelector("input[name='duration']").value = courseData.duration + " days";
        document.querySelector("input[name='coursefee']").value = courseData.coursefee;
      }

      if (selectedCourse) {
        loadBatchesForCourse(selectedCourse, null);
      } else {
        document.getElementById("batchDropdown").innerHTML = '<option value="">Select</option>';
      }
    });

    // When batch changes
    document.getElementById("batchDropdown").addEventListener("change", function () {
      const selectedBatchId = this.value;
      const status = batchMap.get(selectedBatchId) || "";
      document.getElementById("batchStatus").value = status;
    });

    // Submit form
    document.getElementById("editForm").addEventListener("submit", function (e) {
      if (!validateMobileNumber()) return;
      e.preventDefault();
      const formData = new FormData(this);
      const updatedStudent = Object.fromEntries(formData);
      fetch("http://localhost:8080/api/students/" + student.id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedStudent)
      }).then(res => {
        if (!res.ok) throw new Error("Update failed");
        alert("✅ Student updated successfully");
        window.location.href = "/studenthome";
      });
    });

    function validateMobileNumber() {
      const mobile = document.getElementById("mobile").value.trim();
      return /^[1-9][0-9]{9}$/.test(mobile);
    }

    // Fee calculations
    document.getElementById("coursefee").addEventListener("input", calculateTotalFee);
    document.getElementById("discount").addEventListener("input", calculateTotalFee);
    function calculateTotalFee() {
      const courseFee = parseFloat(document.getElementById("coursefee").value) || 0;
      const discount = parseFloat(document.getElementById("discount").value) || 0;
      document.getElementById("totalfee").value = Math.max(courseFee - discount, 0);
    }

    document.getElementById("term_1").addEventListener("input", calculateDueAmount);
    document.getElementById("totalfee").addEventListener("input", calculateDueAmount);
    function calculateDueAmount() {
      const total = parseFloat(document.getElementById("totalfee").value) || 0;
      const term1 = parseFloat(document.getElementById("term_1").value) || 0;
      document.getElementById("duefee").value = Math.max(total - term1, 0);
    }

    // Auto-fill Paid Amount when Term-1 Fees entered
    document.getElementById("term_1").addEventListener("input", function () {
      document.querySelector("input[name='paidamount']").value = this.value;
    });

    // Load username
    fetch("http://localhost:8080/api/username", { credentials: 'include' })
      .then(res => res.text())
      .then(username => document.getElementById("username").innerText = username)
      .catch(() => document.getElementById("username").innerText = "Guest");

    // Step navigation
    function showStep(step) {
      steps.forEach(s => s.classList.toggle("hidden", s.dataset.step !== step));
      tabBtns.forEach(btn => {
        btn.classList.toggle("text-indigo-600", btn.dataset.step === step);
        btn.classList.toggle("border-indigo-600", btn.dataset.step === step);
        btn.classList.toggle("text-gray-500", btn.dataset.step !== step);
        btn.classList.toggle("border-b-2", btn.dataset.step === step);
      });
    }

    document.querySelectorAll(".next-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.dataset.next === "4") generatePreview();
        showStep(btn.dataset.next);
      });
    });
    document.querySelectorAll(".prev-btn").forEach(btn => {
      btn.addEventListener("click", () => showStep(btn.dataset.prev));
    });
    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.dataset.step === "4") generatePreview();
        showStep(btn.dataset.step);
      });
    });

    // Preview function
    function generatePreview() {
      const formData = new FormData(document.getElementById("editForm"));
      const previewDiv = document.getElementById("previewContent");
      previewDiv.innerHTML = "";

      const sections = {
        "Personal Information": { icon: "fa-user", fields: ["name", "email", "mobile", "dob", "gender", "address"] },
        "Course Details": { icon: "fa-book", fields: ["qualification", "joiningDate", "batch", "status", "course", "duration"] },
        "Payment Details": { icon: "fa-credit-card", fields: ["coursefee", "discount", "totalfee", "term_1", "paidamount", "duefee"] }
      };

      for (const [sectionTitle, sectionData] of Object.entries(sections)) {
        const sectionDiv = document.createElement("div");
        sectionDiv.classList.add("mb-6", "bg-gray-50", "p-4", "rounded-lg", "shadow");
        sectionDiv.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-[var(--primary-color)]"><i class="fa ${sectionData.icon} mr-2"></i>${sectionTitle}</h3>`;
        const grid = document.createElement("div");
        grid.classList.add("grid", "grid-cols-1", "md:grid-cols-2", "gap-4");

        sectionData.fields.forEach(fieldName => {
          const value = formData.get(fieldName) || "—";
          grid.innerHTML += `<div><div class="text-sm font-medium text-gray-500">${fieldName.replace(/_/g, " ").toUpperCase()}</div><div class="text-base text-gray-800">${value}</div></div>`;
        });

        sectionDiv.appendChild(grid);
        previewDiv.appendChild(sectionDiv);
      }
    }

    function validateForm() {
      alert("Form submitted successfully!");
      return true;
    }

    // Start at step 1
    showStep("1");
</script>


</body>
</html>
